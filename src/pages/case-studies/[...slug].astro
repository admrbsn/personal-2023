---
import { Image } from "astro:assets"
import arrowBack from '@icon/arrow-back.svg'
import { type CollectionEntry, getCollection } from 'astro:content'
import BaseHead from '../../components/BaseHead.astro'
import 'photoswipe/style.css'

// Load the collection and define the static paths
export async function getStaticPaths() {
  const posts = await getCollection('case-studies')
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }))
}

// Define the type for the props
type Props = CollectionEntry<'case-studies'>['data']

// Load the current post data
const post = Astro.props
const { title, description, role, scope, team, timeline, metrics, liveSiteUrl, liveSiteText } = post.data
const { Content } = await post.render()
const allImageFiles = await Astro.glob(`../../assets/img/**/*`)

// Process markdown to add section IDs based on PROCESS comments
const processSections = [
  { id: 'discover', label: 'Research', comment: 'DISCOVER' },
  { id: 'explore-define', label: 'Ideate', comment: 'EXPLORE_DEFINE' },
  { id: 'develop-test', label: 'Make', comment: 'DEVELOP_TEST' },
  { id: 'delivery', label: 'Delivery', comment: 'DELIVERY' }
]

// Check if this case study has process sections (only tribute-v3 for now)
const hasProcessSections = post.slug === 'tribute-v3'

console.log("All Image Files:", allImageFiles)

const heroImageFile = allImageFiles.filter(file => {
  return file.default.src.includes(`${post.slug}-hero`)
})[0] // Ensure only the first match is used

const imageFiles = allImageFiles.filter(file => {
  return file.default.src.includes(`${post.slug}-gallery`)
})
---

<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
    <script is:inline>
      !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug getPageViewId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
      posthog.init('phc_sBh15Z6BMLUdSGa9qVgoo0HPwsA1cy2RJ1uudLzSdur', {
          api_host: 'https://us.i.posthog.com',
          person_profiles: 'identified_only', // or 'always' to create profiles for anonymous users as well
      })
    </script>
  </head>
  <body>
    <header role="banner" class="md:flex-row md:items-center md:mx-auto md:px-0 relative z-50 flex justify-between w-full max-w-6xl px-3 py-5">
      <div>
        <h1 id="adam-logo" class="md:fixed p-2 text-2xl font-extrabold tracking-wide text-white uppercase bg-black rounded-sm">Adam</h1>
      </div>
      <a href="/" class="relative md:top-6 flex items-center text-black font-semibold">
        <Image class="w-6 mr-1.5 " src={arrowBack} alt="Back icon."/>
        Back<span class="hidden md:inline">&nbsp;home</span>
      </a>
    </header>
    <main>
      <!-- Hero -->
      <div id="hero" class="relative z-30 max-w-6xl mx-auto px-3 md:px-0">
        {
          heroImageFile ? (
          <div style={`background-image: url(${heroImageFile.default.src});`} class="w-full h-96 md:h-[500px] md:mt-12 bg-cover bg-center bg-[#E1D6CE] rounded-sm"></div>
          ) : (
          <div class="w-full h-96 md:h-[500px] md:mt-12 bg-[#f5f5f5] rounded-sm border border-gray-200"></div>
          )
        }
      </div>
      <!-- At a glance section -->
      {(role || scope || team || timeline) && (
        <div class="max-w-6xl mx-auto px-3 md:px-0 mt-8 md:mt-12 mb-12">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-8 md:gap-6">
            {role && (
              <div>
                <h3 class="text-sm font-semibold uppercase tracking-wide mb-3 text-center text-gray-600">Role</h3>
                <p class="text-base leading-relaxed text-center">{role}</p>
              </div>
            )}
            {scope && (
              <div>
                <h3 class="text-sm font-semibold uppercase tracking-wide mb-3 text-center text-gray-600">Scope</h3>
                <p class="text-base leading-relaxed text-center">{scope}</p>
              </div>
            )}
            {team && (
              <div>
                <h3 class="text-sm font-semibold uppercase tracking-wide mb-3 text-center text-gray-600">Team</h3>
                <p class="text-base leading-relaxed text-center">{team}</p>
              </div>
            )}
            {timeline && (
              <div>
                <h3 class="text-sm font-semibold uppercase tracking-wide mb-3 text-center text-gray-600">Timeline</h3>
                <p class="text-base leading-relaxed text-center">{timeline}</p>
              </div>
            )}
          </div>
        </div>
      )}
      <!-- Process Navigation (sticky) -->
      {hasProcessSections && (
        <nav id="process-nav" class="sticky top-0 z-50 bg-white border-b border-gray-200 mb-8 md:mb-12">
          <div class="max-w-6xl md:max-w-3xl mx-auto px-3 md:px-0 py-6">
            <h4 class="sr-only">Process</h4>
            <div aria-hidden="true">
              <div class="overflow-hidden rounded-full bg-gray-200">
                <div id="process-progress" class="h-2 rounded-full bg-black transition-all duration-500 ease-out" style="width: 0%"></div>
              </div>
              <div class="mt-6 grid grid-cols-4 text-sm font-medium text-gray-600">
                {processSections.map((section, index) => (
                  <div 
                    class={`process-step-label ${index === 0 ? '' : index === processSections.length - 1 ? 'text-right' : 'text-center'} ${index === 0 ? 'opacity-100' : 'opacity-50'}`}
                    data-section={section.id}
                  >
                    {section.label}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </nav>
      )}
      <!-- Article section -->
      <article class="md:max-w-3xl mt-8 md:mt-12 md:mb-24 md:mx-auto px-4 md:px-0 z-40">
        <div class="prose process-content">
          <Content />
        </div>
        <!-- Gallery section -->
        <h2 class="mt-12 pt-8 border-t-2">Images of the Process</h2>
        <div id="gallery" class="grid grid-cols-2 gap-2 md:grid-cols-4 md:gap-3">
          {
            imageFiles.map((img) => (
              <a
                href={img.default.src}
                data-pswp-width={img.default.width.toString()}
                data-pswp-height={img.default.height.toString()}
                target="_blank"
              >
                <img
                  src={img.default.src}
                  width={img.default.width}
                  height={img.default.height}
                  alt="Image."
                  class="w-full aspect-[4/3] object-cover rounded"
                />
              </a>
            ))
          }
        </div>        
      </article>
      <!-- Metrics section -->
      {(metrics && metrics.length > 0) && (
        <section class="max-w-6xl mx-auto px-3 md:px-0 mt-16 md:mt-24 mb-12">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-8 md:gap-12 mb-16">
            {metrics.map((metric) => (
              <div class="text-center">
                <div class="text-4xl md:text-5xl font-bold mb-2 text-gray-900">{metric.value}</div>
                {metric.description ? (
                  <>
                    <div class="text-sm text-gray-600 mb-1">{metric.description}</div>
                    <div class="text-base text-gray-900">{metric.label}</div>
                  </>
                ) : (
                  <>
                    <div class="text-sm text-gray-600 mb-1">Increase In</div>
                    <div class="text-base text-gray-900">{metric.label}</div>
                  </>
                )}
              </div>
            ))}
          </div>
          {liveSiteUrl && (
            <div class="text-center mb-12">
              <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-900">View the Live Site</h2>
              <p class="text-base text-gray-600 max-w-2xl mx-auto leading-relaxed">
                {liveSiteText ? (
                  <>
                    {liveSiteText.replace(liveSiteUrl, '').trim()}{' '}
                    <a href={liveSiteUrl} target="_blank" rel="noopener noreferrer" class="underline hover:no-underline">{liveSiteUrl}</a>.
                  </>
                ) : (
                  <>
                    To view the live site and experience the improved experience, visit{' '}
                    <a href={liveSiteUrl} target="_blank" rel="noopener noreferrer" class="underline hover:no-underline">{liveSiteUrl}</a>.
                  </>
                )}
              </p>
            </div>
          )}
        </section>
      )}
      <!-- Scroll to top button -->
      <button 
        id="scroll-to-top" 
        class="fixed bottom-8 right-8 w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-all opacity-0 pointer-events-none z-50"
        aria-label="Scroll to top"
      >
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
      </button>
    </main>
  </body>
</html>

<script>
  // Process navigation setup
  const processSections = [
    { id: 'discover', label: 'Discover', comment: 'DISCOVER' },
    { id: 'explore-define', label: 'Explore & Define', comment: 'EXPLORE_DEFINE' },
    { id: 'develop-test', label: 'Develop & Test', comment: 'DEVELOP_TEST' },
    { id: 'delivery', label: 'Delivery', comment: 'DELIVERY' }
  ]

  // Add IDs to sections based on PROCESS comments
  function setupProcessSections() {
    const processNav = document.getElementById('process-nav')
    if (!processNav) {
      console.log('Process nav not found')
      return
    }

    const content = document.querySelector('.process-content')
    if (!content) {
      console.log('Process content not found')
      return
    }

    // Find all h2 headings
    const headings = Array.from(content.querySelectorAll('h2'))
    console.log(`Found ${headings.length} headings:`, headings.map(h => h.textContent?.trim()))
    
    if (headings.length === 0) {
      console.warn('No h2 headings found in .process-content')
      return
    }
    
    // Map PROCESS comments to headings - matches tribute-v3.md structure
    const sectionMap = {
      'discover': ['Background'],
      'explore-define': ['Framing the Direction'],
      'develop-test': ['Shaping the Experience'],
      'delivery': ['Launch and Outcomes']
    }

    // Match headings by exact text and assign our custom IDs
    // We need to override any auto-generated IDs from the markdown renderer
    headings.forEach((heading) => {
      const headingText = heading.textContent?.trim() || ''
      
      for (const [sectionId, keywords] of Object.entries(sectionMap)) {
        if (keywords.some(keyword => headingText === keyword)) {
          // Remove any existing ID and set our custom one
          heading.removeAttribute('id')
          heading.id = sectionId
          heading.setAttribute('data-process-section', sectionId)
          console.log(`Matched "${headingText}" to section: ${sectionId}`)
          break
        }
      }
    })

    // Verify IDs were set
    const foundSections = processSections.map(s => {
      const section = document.getElementById(s.id)
      return { id: s.id, found: !!section, heading: section?.textContent?.trim() }
    })
    console.log('Process sections found:', foundSections)
    
    // Log all headings with their final IDs
    headings.forEach((heading, index) => {
      const isProcessSection = processSections.some(s => s.id === heading.id)
      if (isProcessSection) {
        console.log(`Process section ${index}: "${heading.textContent?.trim()}" â†’ ID: ${heading.id}`)
      }
    })
  }

  // Track active section with Intersection Observer
  function setupSectionTracking() {
    const processNav = document.getElementById('process-nav')
    if (!processNav) return

    const progressBar = document.getElementById('process-progress')
    if (!progressBar) return

    // Find sections by ID
    const sections = processSections.map(s => {
      const section = document.getElementById(s.id)
      if (!section) {
        console.warn(`Section ${s.id} not found`)
      }
      return section
    }).filter(Boolean)
    
    if (sections.length === 0) {
      console.warn('No process sections found')
      return
    }

    const stepLabels = document.querySelectorAll('.process-step-label')
    const totalSteps = processSections.length
    
    const observerOptions = {
      root: null,
      rootMargin: '-10% 0px -70% 0px',
      threshold: [0, 0.25, 0.5, 0.75, 1]
    }

    let currentActiveIndex = 0

    const observer = new IntersectionObserver((entries) => {
      // Find the section with the highest intersection ratio
      let maxRatio = 0
      let activeSectionId = null

      entries.forEach((entry) => {
        if (entry.intersectionRatio > maxRatio) {
          maxRatio = entry.intersectionRatio
          activeSectionId = entry.target.id
        }
      })

      if (activeSectionId) {
        const activeIndex = processSections.findIndex(s => s.id === activeSectionId)
        
        if (activeIndex !== -1 && activeIndex !== currentActiveIndex) {
          currentActiveIndex = activeIndex
          
          // Calculate progress percentage
          // For 4 steps: 0% (step 1), 33.33% (step 2), 66.66% (step 3), 100% (step 4)
          const progress = (activeIndex / (totalSteps - 1)) * 100
          if (progressBar instanceof HTMLElement) {
            progressBar.style.width = `${progress}%`
          }
          
            // Update step labels
            stepLabels.forEach((label, index) => {
              if (index <= activeIndex) {
                // Active or completed steps
                label.classList.remove('text-gray-600', 'opacity-50')
                label.classList.add('text-black', 'font-semibold', 'opacity-100')
              } else {
                // Future steps
                label.classList.remove('text-black', 'font-semibold', 'opacity-100')
                label.classList.add('text-gray-600', 'opacity-50')
              }
            })
        }
      }
    }, observerOptions)

    sections.forEach((section) => {
      observer.observe(section)
    })
  }

  // Set initial active state based on scroll position
  function setInitialActiveState() {
    const progressBar = document.getElementById('process-progress')
    const stepLabels = document.querySelectorAll('.process-step-label')
    
    if (!progressBar) return
    
    // Find which section is currently in view
    let activeIndex = 0
    const viewportTop = window.scrollY + (window.innerHeight * 0.3) // 30% from top
    
    processSections.forEach((section, index) => {
      const sectionEl = document.getElementById(section.id)
      if (sectionEl) {
        const rect = sectionEl.getBoundingClientRect()
        const sectionTop = rect.top + window.scrollY
        
        if (sectionTop <= viewportTop) {
          activeIndex = index
        }
      }
    })
    
    // Set progress bar
    const totalSteps = processSections.length
    const progress = (activeIndex / (totalSteps - 1)) * 100
    if (progressBar instanceof HTMLElement) {
      progressBar.style.width = `${progress}%`
    }
    
    // Set step labels
    stepLabels.forEach((label, index) => {
      if (index <= activeIndex) {
        label.classList.remove('text-gray-600', 'opacity-50')
        label.classList.add('text-black', 'font-semibold', 'opacity-100')
      } else {
        label.classList.remove('text-black', 'font-semibold', 'opacity-100')
        label.classList.add('text-gray-600', 'opacity-50')
      }
    })
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    // Wait for content to be fully rendered
    setTimeout(() => {
      setupProcessSections()
      setInitialActiveState()
      setupSectionTracking()
    }, 500)
  })
  
  // Also try after a longer delay in case content loads slowly
  setTimeout(() => {
    if (document.getElementById('process-nav') && !document.getElementById('discover')) {
      console.log('Retrying section setup after delay...')
      setupProcessSections()
      setInitialActiveState()
      setupSectionTracking()
    }
  }, 1000)

  // Modifying the DOM on scroll
  window.addEventListener('scroll', (event: Event) => {
    const scrollTop = window.pageYOffset as number
    const hero = document.getElementById('hero') as HTMLElement
    const scrollToTopBtn = document.getElementById('scroll-to-top') as HTMLElement

    // Setting hero opacity
    hero.style.opacity = `${0 + (hero.offsetHeight - scrollTop) / hero.offsetHeight}`

    // Show/hide scroll to top button
    if (scrollToTopBtn) {
      if (scrollTop > 300) {
        scrollToTopBtn.classList.remove('opacity-0', 'pointer-events-none')
        scrollToTopBtn.classList.add('opacity-100', 'pointer-events-auto')
      } else {
        scrollToTopBtn.classList.add('opacity-0', 'pointer-events-none')
        scrollToTopBtn.classList.remove('opacity-100', 'pointer-events-auto')
      }
    }
  }, false)

  // Scroll to top functionality
  const scrollToTopBtn = document.getElementById('scroll-to-top')
  if (scrollToTopBtn) {
    scrollToTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' })
    })
  }

  // Smooth scroll for process step labels
  document.querySelectorAll('.process-step-label').forEach((label) => {
    if (label instanceof HTMLElement) {
      label.style.cursor = 'pointer'
    }
    label.addEventListener('click', () => {
      const sectionId = label.getAttribute('data-section')
      if (sectionId) {
        const target = document.getElementById(sectionId)
        if (target) {
          const navHeight = document.getElementById('process-nav')?.offsetHeight || 0
          const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - navHeight - 20
          window.scrollTo({ top: targetPosition, behavior: 'smooth' })
        }
      }
    })
  })
</script>

<script type="module">
  //TODO: use node module instead
  import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe/dist/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#gallery',
    children: 'a',
    pswpModule: () => import('https://unpkg.com/photoswipe'),
  });

  lightbox.init();
</script>

<style>
  body:before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: -10;
    @apply bg-gradient-to-b from-[#f5f5f5] to-[#ffffff];
  }
  #adam-logo.inverted {
    @apply bg-white text-black;
  }
  #adam-logo.inverted:before {
    @apply bg-white;
  }
  h1:before {
    @apply absolute -top-full left-0 w-full h-full bg-black;
    content: "";
  }
  :global(h2) {
    @apply mb-4  text-xl md:text-2xl font-heading font-extrabold tracking-tight md:leading-tight;
  }
  :global(h3) {
    @apply mb-4  text-lg md:text-xl font-heading font-extrabold tracking-tight md:leading-tight;
  }
  :global(h4) {
    @apply mb-4  text-base md:text-lg font-heading font-extrabold tracking-tight md:leading-tight;
  }
  :global(p) {
    @apply mb-8 text-[#404040] text-[17px] leading-relaxed;
  }
  :global(strong) {
    @apply text-black font-bold;
  }
  :global(ul) {
    @apply list-disc mt-4 mr-8 md:mr-12 ml-8 md:ml-12;
  }
  :global(ul li) {
    @apply mb-4 text-[#404040] text-base leading-relaxed;
  }
  :global(ol) {
    @apply list-decimal mt-4 mr-8 md:mr-12 ml-8 md:ml-12;
  }
  :global(ol li) {
    @apply mb-4 text-[#404040]  text-base leading-relaxed;
  }
  :global(.ipad) {
    @apply relative block mb-16 md:p-[24px] md:pr-[48px] bg-gradient-to-r from-[#fff] to-[#f1f1f3] rounded-xl shadow-[12px_12px_36px_-0px_rgba(0,0,0,0.1875)];
  }
  :global(.ipad:before) {
    content: '';
    @apply hidden md:block absolute right-2 w-8 h-8 inset-y-0 my-auto bg-[#e7e7e7] border-2 border-[#d4d4dd] rounded-full shadow-[inset_2px_0px_6px_rgba(0,0,0,0.1)];
  }
  :global(.ipad:after) {
    content: '';
    @apply hidden md:block absolute left-2.5 w-1.5 h-10 inset-y-0 my-auto bg-[#f0f0f0] rounded-full shadow-[inset_1px_0px_2px_rgba(0,0,0,0.1)];
  }
  :global(.ipad .screen) {
    @apply relative block overflow-scroll aspect-video md:shadow-[inset_1px_0px_6px_0px_rgba(0,0,0,0.25)] z-10 rounded md:rounded-none;
  }
  :global(.ipad img) {
    @apply mix-blend-color;
  }
  :global(.caption) {
    @apply text-sm italic opacity-60;
  }
  :global(.inline-img img) {
    @apply rounded;
  }
  :global(pre) {
    @apply p-8 rounded-sm text-sm;
  }
  #gallery a img {
    border: 2px solid transparent;
    @apply transition-all;
  }
  #gallery a:hover img {
    border: 2px solid black;
  }
  /* Process Navigation Styles */
  #process-nav {
    transition: all 0.3s ease;
  }
  #process-progress {
    transition: width 0.5s ease-out;
  }
  .process-step-label {
    transition: color 0.3s ease;
  }
  .process-step-label:hover {
    color: #000;
    cursor: pointer;
  }
</style>
